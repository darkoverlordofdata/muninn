(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var AppRouter, models, utils, views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  utils = require('./utils');

  views = require('./views');

  models = require('./models');

  require('./models/Wine');

  require('./models/WineCollection');

  require('./views/AboutView');

  require('./views/HeaderView');

  require('./views/HomeView');

  require('./views/Paginator');

  require('./views/WineView');

  require('./views/WineListView');

  require('./views/WineListItemView');

  AppRouter = (function(_super) {
    __extends(AppRouter, _super);

    AppRouter.prototype.routes = {
      "": "home",
      "wines": "list",
      "wines/page/:page": "list",
      "wines/add": "addWine",
      "wines/:id": "wineDetails",
      "about": "about"
    };

    function AppRouter() {
      AppRouter.__super__.constructor.apply(this, arguments);
      this.headerView = new views.HeaderView();
      $(".header").html(this.headerView.el);
    }

    AppRouter.prototype.home = function(id) {
      if (!this.homeView) {
        this.homeView = new views.HomeView();
      }
      $("#content").html(this.homeView.el);
      return this.headerView.selectMenuItem("home-menu");
    };

    AppRouter.prototype.list = function(page) {
      var p, wineList;
      p = page ? parseInt(page, 10) : 1;
      wineList = new models.WineCollection();
      wineList.fetch({
        success: function() {
          return $("#content").html(new views.WineListView({
            model: wineList,
            page: p
          }).el);
        }
      });
      return this.headerView.selectMenuItem("home-menu");
    };

    AppRouter.prototype.wineDetails = function(id) {
      var wine;
      wine = new models.Wine({
        _id: id
      });
      wine.fetch({
        success: function() {
          return $("#content").html(new views.WineView({
            model: wine
          }).el);
        }
      });
      return this.headerView.selectMenuItem();
    };

    AppRouter.prototype.addWine = function() {
      var wine;
      wine = new models.Wine();
      $("#content").html(new views.WineView({
        model: wine
      }).el);
      return this.headerView.selectMenuItem("add-menu");
    };

    AppRouter.prototype.about = function() {
      if (!this.aboutView) {
        this.aboutView = new views.AboutView();
      }
      $("#content").html(this.aboutView.el);
      return this.headerView.selectMenuItem("about-menu");
    };

    return AppRouter;

  })(Backbone.Router);

  utils.loadTemplate(["HomeView", "HeaderView", "WineView", "WineListItemView", "AboutView"], function() {
    new AppRouter;
    return Backbone.history.start();
  });

}).call(this);

},{"./models":2,"./models/Wine":3,"./models/WineCollection":4,"./utils":5,"./views":6,"./views/AboutView":7,"./views/HeaderView":8,"./views/HomeView":9,"./views/Paginator":10,"./views/WineListItemView":11,"./views/WineListView":12,"./views/WineView":13}],2:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {


}).call(this);

},{}],3:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var models,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  models = require('../models');

  models.Wine = (function(_super) {
    __extends(Wine, _super);

    Wine.prototype.urlRoot = "/wines";

    Wine.prototype.idAttribute = "_id";

    function Wine() {
      Wine.__super__.constructor.apply(this, arguments);
      this.validators = {};
      this.validators.name = function(value) {
        if (value.length > 0) {
          return {
            isValid: true
          };
        } else {
          return {
            isValid: false,
            message: "You must enter a name"
          };
        }
      };
      this.validators.grapes = function(value) {
        if (value.length > 0) {
          return {
            isValid: true
          };
        } else {
          return {
            isValid: false,
            message: "You must enter a grape variety"
          };
        }
      };
      this.validators.country = function(value) {
        if (value.length > 0) {
          return {
            isValid: true
          };
        } else {
          return {
            isValid: false,
            message: "You must enter a country"
          };
        }
      };
    }

    Wine.prototype.validateItem = function(key) {
      if (this.validators[key]) {
        return this.validators[key](this.get(key));
      } else {
        return {
          isValid: true
        };
      }
    };

    Wine.prototype.validateAll = function() {
      var check, key, messages;
      messages = {};
      for (key in this.validators) {
        if (this.validators.hasOwnProperty(key)) {
          check = this.validators[key](this.get(key));
          if (check.isValid === false) {
            messages[key] = check.message;
          }
        }
      }
      if (_.size(messages) > 0) {
        return {
          isValid: false,
          messages: messages
        };
      } else {
        return {
          isValid: true
        };
      }
    };

    Wine.prototype.defaults = {
      _id: null,
      name: "",
      grapes: "",
      country: "USA",
      region: "California",
      year: 0,
      description: "",
      picture: null
    };

    return Wine;

  })(Backbone.Model);

}).call(this);

},{"../models":2}],4:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var models, _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  models = require('../models');

  models.WineCollection = (function(_super) {
    __extends(WineCollection, _super);

    function WineCollection() {
      _ref = WineCollection.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    WineCollection.prototype.model = models.Wine;

    WineCollection.prototype.url = "/wines";

    return WineCollection;

  })(Backbone.Collection);

}).call(this);

},{"../models":2}],5:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var DOMFileSystem;

  DOMFileSystem = (function() {
    function DOMFileSystem() {}

    DOMFileSystem.prototype.readTemplateFile = function($template) {
      var el;
      if ((el = $('#' + $template)) != null) {
        return el.text();
      } else {
        throw Liquid.FileSystemError("Template not found: " + $template);
      }
    };

    return DOMFileSystem;

  })();

  Liquid.Template.fileSystem = new DOMFileSystem;

  module.exports = {
    loadTemplate: function(views, callback) {
      var classes, deferreds;
      classes = require('./views');
      deferreds = [];
      $.each(views, function(index, view) {
        if (classes[view]) {
          return deferreds.push($.get("tpl/" + view + ".liquid", function(template) {
            return classes[view].prototype.template = Liquid.Template.parse(template);
          }));
        } else {
          return alert(view + " not found");
        }
      });
      return $.when.apply(null, deferreds).done(callback);
    },
    displayValidationErrors: function(messages) {
      var key;
      for (key in messages) {
        if (messages.hasOwnProperty(key)) {
          this.addValidationError(key, messages[key]);
        }
      }
      return this.showAlert("Warning!", "Fix validation errors and try again", "alert-warning");
    },
    addValidationError: function(field, message) {
      var controlGroup;
      controlGroup = $("#" + field).parent().parent();
      controlGroup.addClass("error");
      return $(".help-inline", controlGroup).html(message);
    },
    removeValidationError: function(field) {
      var controlGroup;
      controlGroup = $("#" + field).parent().parent();
      controlGroup.removeClass("error");
      return $(".help-inline", controlGroup).html("");
    },
    showAlert: function(title, text, klass) {
      $(".alert").removeClass("alert-error alert-warning alert-success alert-info");
      $(".alert").addClass(klass);
      $(".alert").html("<strong>" + title + "</strong> " + text);
      return $(".alert").show();
    },
    hideAlert: function() {
      return $(".alert").hide();
    }
  };

}).call(this);

},{"./views":6}],6:[function(require,module,exports){
module.exports=require(2)
},{}],7:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.AboutView = (function(_super) {
    __extends(AboutView, _super);

    function AboutView(options) {
      this.options = options;
      AboutView.__super__.constructor.apply(this, arguments);
      this.render();
    }

    AboutView.prototype.render = function() {
      $(this.el).html(this.template.render());
      return this;
    };

    return AboutView;

  })(Backbone.View);

}).call(this);

},{"../views":6}],8:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.HeaderView = (function(_super) {
    __extends(HeaderView, _super);

    function HeaderView(options) {
      this.options = options;
      HeaderView.__super__.constructor.apply(this, arguments);
      this.render();
    }

    HeaderView.prototype.render = function() {
      $(this.el).html(this.template.render());
      return this;
    };

    HeaderView.prototype.selectMenuItem = function(menuItem) {
      $(".nav li").removeClass("active");
      if (menuItem) {
        return $("." + menuItem).addClass("active");
      }
    };

    return HeaderView;

  })(Backbone.View);

}).call(this);

},{"../views":6}],9:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.HomeView = (function(_super) {
    __extends(HomeView, _super);

    function HomeView(options) {
      this.options = options;
      HomeView.__super__.constructor.apply(this, arguments);
      this.render();
    }

    HomeView.prototype.render = function() {
      var src, template;
      $(this.el).html(this.template.render());
      src = "{% include 'hello-tpl' with current_user:'Fred' %}";
      template = Liquid.Template.parse(src);
      console.log('------------------');
      console.log(template.render());
      console.log('------------------');
      return this;
    };

    return HomeView;

  })(Backbone.View);

}).call(this);

},{"../views":6}],10:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.Paginator = (function(_super) {
    __extends(Paginator, _super);

    Paginator.prototype.className = "pagination pagination-centered";

    function Paginator(options) {
      this.options = options;
      Paginator.__super__.constructor.apply(this, arguments);
      this.model.bind("reset", this.render, this);
      this.render();
    }

    Paginator.prototype.render = function() {
      var i, items, len, pageCount;
      items = this.model.models;
      len = items.length;
      pageCount = Math.ceil(len / 8);
      $(this.el).html("<ul />");
      i = 0;
      while (i < pageCount) {
        $("ul", this.el).append("<li" + ((i + 1) === this.options.page ? " class='active'" : "") + "><a href='#wines/page/" + (i + 1) + "'>" + (i + 1) + "</a></li>");
        i++;
      }
      return this;
    };

    return Paginator;

  })(Backbone.View);

}).call(this);

},{"../views":6}],11:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.WineListItemView = (function(_super) {
    __extends(WineListItemView, _super);

    WineListItemView.prototype.tagName = "li";

    function WineListItemView(options) {
      this.options = options;
      WineListItemView.__super__.constructor.apply(this, arguments);
      this.model.bind("change", this.render, this);
      this.model.bind("destroy", this.close, this);
    }

    WineListItemView.prototype.render = function() {
      $(this.el).html(this.template.render(this.model.toJSON()));
      return this;
    };

    return WineListItemView;

  })(Backbone.View);

}).call(this);

},{"../views":6}],12:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  views = require('../views');

  views.WineListView = (function(_super) {
    __extends(WineListView, _super);

    function WineListView(options) {
      this.options = options;
      WineListView.__super__.constructor.apply(this, arguments);
      this.render();
    }

    WineListView.prototype.render = function() {
      var endPos, i, len, startPos, wines;
      wines = this.model.models;
      len = wines.length;
      startPos = (this.options.page - 1) * 8;
      endPos = Math.min(startPos + 8, len);
      $(this.el).html("<ul class=\"thumbnails\"></ul>");
      i = startPos;
      while (i < endPos) {
        $(".thumbnails", this.el).append(new views.WineListItemView({
          model: wines[i]
        }).render().el);
        i++;
      }
      $(this.el).append(new views.Paginator({
        model: this.model,
        page: this.options.page
      }).render().el);
      return this;
    };

    return WineListView;

  })(Backbone.View);

}).call(this);

},{"../views":6}],13:[function(require,module,exports){
// Generated by CoffeeScript 1.6.3
(function() {
  var utils, views,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  utils = require('../utils');

  views = require('../views');

  views.WineView = (function(_super) {
    __extends(WineView, _super);

    function WineView(options) {
      this.options = options;
      WineView.__super__.constructor.apply(this, arguments);
      this.render();
    }

    WineView.prototype.render = function() {
      $(this.el).html(this.template.render(this.model.toJSON()));
      return this;
    };

    WineView.prototype.events = function() {
      return {
        "change": "change",
        "click .save": "beforeSave",
        "click .delete": "deleteWine",
        "drop #picture": "dropHandler"
      };
    };

    WineView.prototype.change = function(event) {
      var change, check, target;
      utils.hideAlert();
      target = event.target;
      change = {};
      change[target.name] = target.value;
      this.model.set(change);
      check = this.model.validateItem(target.id);
      if (check.isValid === false) {
        return utils.addValidationError(target.id, check.message);
      } else {
        return utils.removeValidationError(target.id);
      }
    };

    WineView.prototype.beforeSave = function() {
      var check;
      check = this.model.validateAll();
      if (check.isValid === false) {
        utils.displayValidationErrors(check.messages);
        return false;
      }
      this.saveWine();
      return false;
    };

    WineView.prototype.saveWine = function() {
      var _this = this;
      console.log("before save");
      return this.model.save(null, {
        success: function(model) {
          _this.render();
          app.navigate("wines/" + model.id, false);
          return utils.showAlert("Success!", "Wine saved successfully", "alert-success");
        },
        error: function() {
          return utils.showAlert("Error", "An error occurred while trying to delete this item", "alert-error");
        }
      });
    };

    WineView.prototype.deleteWine = function() {
      this.model.destroy({
        success: function() {
          alert("Wine deleted successfully");
          return window.history.back();
        }
      });
      return false;
    };

    WineView.prototype.dropHandler = function(event) {
      var e, reader;
      event.stopPropagation();
      event.preventDefault();
      e = event.originalEvent;
      e.dataTransfer.dropEffect = "copy";
      this.pictureFile = e.dataTransfer.files[0];
      reader = new FileReader();
      reader.onloadend = function() {
        return $("#picture").attr("src", reader.result);
      };
      return reader.readAsDataURL(this.pictureFile);
    };

    return WineView;

  })(Backbone.View);

}).call(this);

},{"../utils":5,"../views":6}]},{},[1])
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyIvaG9tZS9icnVjZS9HaXQvbm9kZWNlbGxhci90bXAvbWFpbi5qcyIsIi9ob21lL2JydWNlL0dpdC9ub2RlY2VsbGFyL3RtcC9tb2RlbHMuanMiLCIvaG9tZS9icnVjZS9HaXQvbm9kZWNlbGxhci90bXAvbW9kZWxzL1dpbmUuanMiLCIvaG9tZS9icnVjZS9HaXQvbm9kZWNlbGxhci90bXAvbW9kZWxzL1dpbmVDb2xsZWN0aW9uLmpzIiwiL2hvbWUvYnJ1Y2UvR2l0L25vZGVjZWxsYXIvdG1wL3V0aWxzLmpzIiwiL2hvbWUvYnJ1Y2UvR2l0L25vZGVjZWxsYXIvdG1wL3ZpZXdzL0Fib3V0Vmlldy5qcyIsIi9ob21lL2JydWNlL0dpdC9ub2RlY2VsbGFyL3RtcC92aWV3cy9IZWFkZXJWaWV3LmpzIiwiL2hvbWUvYnJ1Y2UvR2l0L25vZGVjZWxsYXIvdG1wL3ZpZXdzL0hvbWVWaWV3LmpzIiwiL2hvbWUvYnJ1Y2UvR2l0L25vZGVjZWxsYXIvdG1wL3ZpZXdzL1BhZ2luYXRvci5qcyIsIi9ob21lL2JydWNlL0dpdC9ub2RlY2VsbGFyL3RtcC92aWV3cy9XaW5lTGlzdEl0ZW1WaWV3LmpzIiwiL2hvbWUvYnJ1Y2UvR2l0L25vZGVjZWxsYXIvdG1wL3ZpZXdzL1dpbmVMaXN0Vmlldy5qcyIsIi9ob21lL2JydWNlL0dpdC9ub2RlY2VsbGFyL3RtcC92aWV3cy9XaW5lVmlldy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ2pIQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDTEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDekdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDekJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7OztBQ3ZFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUNsQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDakNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3ZDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUM5QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIEFwcFJvdXRlciwgbW9kZWxzLCB1dGlscywgdmlld3MsXG4gICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbiAgdXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5cbiAgdmlld3MgPSByZXF1aXJlKCcuL3ZpZXdzJyk7XG5cbiAgbW9kZWxzID0gcmVxdWlyZSgnLi9tb2RlbHMnKTtcblxuICByZXF1aXJlKCcuL21vZGVscy9XaW5lJyk7XG5cbiAgcmVxdWlyZSgnLi9tb2RlbHMvV2luZUNvbGxlY3Rpb24nKTtcblxuICByZXF1aXJlKCcuL3ZpZXdzL0Fib3V0VmlldycpO1xuXG4gIHJlcXVpcmUoJy4vdmlld3MvSGVhZGVyVmlldycpO1xuXG4gIHJlcXVpcmUoJy4vdmlld3MvSG9tZVZpZXcnKTtcblxuICByZXF1aXJlKCcuL3ZpZXdzL1BhZ2luYXRvcicpO1xuXG4gIHJlcXVpcmUoJy4vdmlld3MvV2luZVZpZXcnKTtcblxuICByZXF1aXJlKCcuL3ZpZXdzL1dpbmVMaXN0VmlldycpO1xuXG4gIHJlcXVpcmUoJy4vdmlld3MvV2luZUxpc3RJdGVtVmlldycpO1xuXG4gIEFwcFJvdXRlciA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgICBfX2V4dGVuZHMoQXBwUm91dGVyLCBfc3VwZXIpO1xuXG4gICAgQXBwUm91dGVyLnByb3RvdHlwZS5yb3V0ZXMgPSB7XG4gICAgICBcIlwiOiBcImhvbWVcIixcbiAgICAgIFwid2luZXNcIjogXCJsaXN0XCIsXG4gICAgICBcIndpbmVzL3BhZ2UvOnBhZ2VcIjogXCJsaXN0XCIsXG4gICAgICBcIndpbmVzL2FkZFwiOiBcImFkZFdpbmVcIixcbiAgICAgIFwid2luZXMvOmlkXCI6IFwid2luZURldGFpbHNcIixcbiAgICAgIFwiYWJvdXRcIjogXCJhYm91dFwiXG4gICAgfTtcblxuICAgIGZ1bmN0aW9uIEFwcFJvdXRlcigpIHtcbiAgICAgIEFwcFJvdXRlci5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgIHRoaXMuaGVhZGVyVmlldyA9IG5ldyB2aWV3cy5IZWFkZXJWaWV3KCk7XG4gICAgICAkKFwiLmhlYWRlclwiKS5odG1sKHRoaXMuaGVhZGVyVmlldy5lbCk7XG4gICAgfVxuXG4gICAgQXBwUm91dGVyLnByb3RvdHlwZS5ob21lID0gZnVuY3Rpb24oaWQpIHtcbiAgICAgIGlmICghdGhpcy5ob21lVmlldykge1xuICAgICAgICB0aGlzLmhvbWVWaWV3ID0gbmV3IHZpZXdzLkhvbWVWaWV3KCk7XG4gICAgICB9XG4gICAgICAkKFwiI2NvbnRlbnRcIikuaHRtbCh0aGlzLmhvbWVWaWV3LmVsKTtcbiAgICAgIHJldHVybiB0aGlzLmhlYWRlclZpZXcuc2VsZWN0TWVudUl0ZW0oXCJob21lLW1lbnVcIik7XG4gICAgfTtcblxuICAgIEFwcFJvdXRlci5wcm90b3R5cGUubGlzdCA9IGZ1bmN0aW9uKHBhZ2UpIHtcbiAgICAgIHZhciBwLCB3aW5lTGlzdDtcbiAgICAgIHAgPSBwYWdlID8gcGFyc2VJbnQocGFnZSwgMTApIDogMTtcbiAgICAgIHdpbmVMaXN0ID0gbmV3IG1vZGVscy5XaW5lQ29sbGVjdGlvbigpO1xuICAgICAgd2luZUxpc3QuZmV0Y2goe1xuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4gJChcIiNjb250ZW50XCIpLmh0bWwobmV3IHZpZXdzLldpbmVMaXN0Vmlldyh7XG4gICAgICAgICAgICBtb2RlbDogd2luZUxpc3QsXG4gICAgICAgICAgICBwYWdlOiBwXG4gICAgICAgICAgfSkuZWwpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB0aGlzLmhlYWRlclZpZXcuc2VsZWN0TWVudUl0ZW0oXCJob21lLW1lbnVcIik7XG4gICAgfTtcblxuICAgIEFwcFJvdXRlci5wcm90b3R5cGUud2luZURldGFpbHMgPSBmdW5jdGlvbihpZCkge1xuICAgICAgdmFyIHdpbmU7XG4gICAgICB3aW5lID0gbmV3IG1vZGVscy5XaW5lKHtcbiAgICAgICAgX2lkOiBpZFxuICAgICAgfSk7XG4gICAgICB3aW5lLmZldGNoKHtcbiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgcmV0dXJuICQoXCIjY29udGVudFwiKS5odG1sKG5ldyB2aWV3cy5XaW5lVmlldyh7XG4gICAgICAgICAgICBtb2RlbDogd2luZVxuICAgICAgICAgIH0pLmVsKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gdGhpcy5oZWFkZXJWaWV3LnNlbGVjdE1lbnVJdGVtKCk7XG4gICAgfTtcblxuICAgIEFwcFJvdXRlci5wcm90b3R5cGUuYWRkV2luZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHdpbmU7XG4gICAgICB3aW5lID0gbmV3IG1vZGVscy5XaW5lKCk7XG4gICAgICAkKFwiI2NvbnRlbnRcIikuaHRtbChuZXcgdmlld3MuV2luZVZpZXcoe1xuICAgICAgICBtb2RlbDogd2luZVxuICAgICAgfSkuZWwpO1xuICAgICAgcmV0dXJuIHRoaXMuaGVhZGVyVmlldy5zZWxlY3RNZW51SXRlbShcImFkZC1tZW51XCIpO1xuICAgIH07XG5cbiAgICBBcHBSb3V0ZXIucHJvdG90eXBlLmFib3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoIXRoaXMuYWJvdXRWaWV3KSB7XG4gICAgICAgIHRoaXMuYWJvdXRWaWV3ID0gbmV3IHZpZXdzLkFib3V0VmlldygpO1xuICAgICAgfVxuICAgICAgJChcIiNjb250ZW50XCIpLmh0bWwodGhpcy5hYm91dFZpZXcuZWwpO1xuICAgICAgcmV0dXJuIHRoaXMuaGVhZGVyVmlldy5zZWxlY3RNZW51SXRlbShcImFib3V0LW1lbnVcIik7XG4gICAgfTtcblxuICAgIHJldHVybiBBcHBSb3V0ZXI7XG5cbiAgfSkoQmFja2JvbmUuUm91dGVyKTtcblxuICB1dGlscy5sb2FkVGVtcGxhdGUoW1wiSG9tZVZpZXdcIiwgXCJIZWFkZXJWaWV3XCIsIFwiV2luZVZpZXdcIiwgXCJXaW5lTGlzdEl0ZW1WaWV3XCIsIFwiQWJvdXRWaWV3XCJdLCBmdW5jdGlvbigpIHtcbiAgICBuZXcgQXBwUm91dGVyO1xuICAgIHJldHVybiBCYWNrYm9uZS5oaXN0b3J5LnN0YXJ0KCk7XG4gIH0pO1xuXG59KS5jYWxsKHRoaXMpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuM1xuKGZ1bmN0aW9uKCkge1xuXG5cbn0pLmNhbGwodGhpcyk7XG4iLCIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciBtb2RlbHMsXG4gICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbiAgbW9kZWxzID0gcmVxdWlyZSgnLi4vbW9kZWxzJyk7XG5cbiAgbW9kZWxzLldpbmUgPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gICAgX19leHRlbmRzKFdpbmUsIF9zdXBlcik7XG5cbiAgICBXaW5lLnByb3RvdHlwZS51cmxSb290ID0gXCIvd2luZXNcIjtcblxuICAgIFdpbmUucHJvdG90eXBlLmlkQXR0cmlidXRlID0gXCJfaWRcIjtcblxuICAgIGZ1bmN0aW9uIFdpbmUoKSB7XG4gICAgICBXaW5lLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgdGhpcy52YWxpZGF0b3JzID0ge307XG4gICAgICB0aGlzLnZhbGlkYXRvcnMubmFtZSA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlzVmFsaWQ6IHRydWVcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwiWW91IG11c3QgZW50ZXIgYSBuYW1lXCJcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy52YWxpZGF0b3JzLmdyYXBlcyA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlzVmFsaWQ6IHRydWVcbiAgICAgICAgICB9O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICAgIG1lc3NhZ2U6IFwiWW91IG11c3QgZW50ZXIgYSBncmFwZSB2YXJpZXR5XCJcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9O1xuICAgICAgdGhpcy52YWxpZGF0b3JzLmNvdW50cnkgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgICBpZiAodmFsdWUubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpc1ZhbGlkOiB0cnVlXG4gICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgICBtZXNzYWdlOiBcIllvdSBtdXN0IGVudGVyIGEgY291bnRyeVwiXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBXaW5lLnByb3RvdHlwZS52YWxpZGF0ZUl0ZW0gPSBmdW5jdGlvbihrZXkpIHtcbiAgICAgIGlmICh0aGlzLnZhbGlkYXRvcnNba2V5XSkge1xuICAgICAgICByZXR1cm4gdGhpcy52YWxpZGF0b3JzW2tleV0odGhpcy5nZXQoa2V5KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzVmFsaWQ6IHRydWVcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgV2luZS5wcm90b3R5cGUudmFsaWRhdGVBbGwgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBjaGVjaywga2V5LCBtZXNzYWdlcztcbiAgICAgIG1lc3NhZ2VzID0ge307XG4gICAgICBmb3IgKGtleSBpbiB0aGlzLnZhbGlkYXRvcnMpIHtcbiAgICAgICAgaWYgKHRoaXMudmFsaWRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgICAgY2hlY2sgPSB0aGlzLnZhbGlkYXRvcnNba2V5XSh0aGlzLmdldChrZXkpKTtcbiAgICAgICAgICBpZiAoY2hlY2suaXNWYWxpZCA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIG1lc3NhZ2VzW2tleV0gPSBjaGVjay5tZXNzYWdlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKF8uc2l6ZShtZXNzYWdlcykgPiAwKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgbWVzc2FnZXM6IG1lc3NhZ2VzXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzVmFsaWQ6IHRydWVcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgV2luZS5wcm90b3R5cGUuZGVmYXVsdHMgPSB7XG4gICAgICBfaWQ6IG51bGwsXG4gICAgICBuYW1lOiBcIlwiLFxuICAgICAgZ3JhcGVzOiBcIlwiLFxuICAgICAgY291bnRyeTogXCJVU0FcIixcbiAgICAgIHJlZ2lvbjogXCJDYWxpZm9ybmlhXCIsXG4gICAgICB5ZWFyOiAwLFxuICAgICAgZGVzY3JpcHRpb246IFwiXCIsXG4gICAgICBwaWN0dXJlOiBudWxsXG4gICAgfTtcblxuICAgIHJldHVybiBXaW5lO1xuXG4gIH0pKEJhY2tib25lLk1vZGVsKTtcblxufSkuY2FsbCh0aGlzKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIG1vZGVscywgX3JlZixcbiAgICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcblxuICBtb2RlbHMgPSByZXF1aXJlKCcuLi9tb2RlbHMnKTtcblxuICBtb2RlbHMuV2luZUNvbGxlY3Rpb24gPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gICAgX19leHRlbmRzKFdpbmVDb2xsZWN0aW9uLCBfc3VwZXIpO1xuXG4gICAgZnVuY3Rpb24gV2luZUNvbGxlY3Rpb24oKSB7XG4gICAgICBfcmVmID0gV2luZUNvbGxlY3Rpb24uX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICByZXR1cm4gX3JlZjtcbiAgICB9XG5cbiAgICBXaW5lQ29sbGVjdGlvbi5wcm90b3R5cGUubW9kZWwgPSBtb2RlbHMuV2luZTtcblxuICAgIFdpbmVDb2xsZWN0aW9uLnByb3RvdHlwZS51cmwgPSBcIi93aW5lc1wiO1xuXG4gICAgcmV0dXJuIFdpbmVDb2xsZWN0aW9uO1xuXG4gIH0pKEJhY2tib25lLkNvbGxlY3Rpb24pO1xuXG59KS5jYWxsKHRoaXMpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgRE9NRmlsZVN5c3RlbTtcblxuICBET01GaWxlU3lzdGVtID0gKGZ1bmN0aW9uKCkge1xuICAgIGZ1bmN0aW9uIERPTUZpbGVTeXN0ZW0oKSB7fVxuXG4gICAgRE9NRmlsZVN5c3RlbS5wcm90b3R5cGUucmVhZFRlbXBsYXRlRmlsZSA9IGZ1bmN0aW9uKCR0ZW1wbGF0ZSkge1xuICAgICAgdmFyIGVsO1xuICAgICAgaWYgKChlbCA9ICQoJyMnICsgJHRlbXBsYXRlKSkgIT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gZWwudGV4dCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgTGlxdWlkLkZpbGVTeXN0ZW1FcnJvcihcIlRlbXBsYXRlIG5vdCBmb3VuZDogXCIgKyAkdGVtcGxhdGUpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4gRE9NRmlsZVN5c3RlbTtcblxuICB9KSgpO1xuXG4gIExpcXVpZC5UZW1wbGF0ZS5maWxlU3lzdGVtID0gbmV3IERPTUZpbGVTeXN0ZW07XG5cbiAgbW9kdWxlLmV4cG9ydHMgPSB7XG4gICAgbG9hZFRlbXBsYXRlOiBmdW5jdGlvbih2aWV3cywgY2FsbGJhY2spIHtcbiAgICAgIHZhciBjbGFzc2VzLCBkZWZlcnJlZHM7XG4gICAgICBjbGFzc2VzID0gcmVxdWlyZSgnLi92aWV3cycpO1xuICAgICAgZGVmZXJyZWRzID0gW107XG4gICAgICAkLmVhY2godmlld3MsIGZ1bmN0aW9uKGluZGV4LCB2aWV3KSB7XG4gICAgICAgIGlmIChjbGFzc2VzW3ZpZXddKSB7XG4gICAgICAgICAgcmV0dXJuIGRlZmVycmVkcy5wdXNoKCQuZ2V0KFwidHBsL1wiICsgdmlldyArIFwiLmxpcXVpZFwiLCBmdW5jdGlvbih0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGNsYXNzZXNbdmlld10ucHJvdG90eXBlLnRlbXBsYXRlID0gTGlxdWlkLlRlbXBsYXRlLnBhcnNlKHRlbXBsYXRlKTtcbiAgICAgICAgICB9KSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIGFsZXJ0KHZpZXcgKyBcIiBub3QgZm91bmRcIik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgcmV0dXJuICQud2hlbi5hcHBseShudWxsLCBkZWZlcnJlZHMpLmRvbmUoY2FsbGJhY2spO1xuICAgIH0sXG4gICAgZGlzcGxheVZhbGlkYXRpb25FcnJvcnM6IGZ1bmN0aW9uKG1lc3NhZ2VzKSB7XG4gICAgICB2YXIga2V5O1xuICAgICAgZm9yIChrZXkgaW4gbWVzc2FnZXMpIHtcbiAgICAgICAgaWYgKG1lc3NhZ2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICB0aGlzLmFkZFZhbGlkYXRpb25FcnJvcihrZXksIG1lc3NhZ2VzW2tleV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5zaG93QWxlcnQoXCJXYXJuaW5nIVwiLCBcIkZpeCB2YWxpZGF0aW9uIGVycm9ycyBhbmQgdHJ5IGFnYWluXCIsIFwiYWxlcnQtd2FybmluZ1wiKTtcbiAgICB9LFxuICAgIGFkZFZhbGlkYXRpb25FcnJvcjogZnVuY3Rpb24oZmllbGQsIG1lc3NhZ2UpIHtcbiAgICAgIHZhciBjb250cm9sR3JvdXA7XG4gICAgICBjb250cm9sR3JvdXAgPSAkKFwiI1wiICsgZmllbGQpLnBhcmVudCgpLnBhcmVudCgpO1xuICAgICAgY29udHJvbEdyb3VwLmFkZENsYXNzKFwiZXJyb3JcIik7XG4gICAgICByZXR1cm4gJChcIi5oZWxwLWlubGluZVwiLCBjb250cm9sR3JvdXApLmh0bWwobWVzc2FnZSk7XG4gICAgfSxcbiAgICByZW1vdmVWYWxpZGF0aW9uRXJyb3I6IGZ1bmN0aW9uKGZpZWxkKSB7XG4gICAgICB2YXIgY29udHJvbEdyb3VwO1xuICAgICAgY29udHJvbEdyb3VwID0gJChcIiNcIiArIGZpZWxkKS5wYXJlbnQoKS5wYXJlbnQoKTtcbiAgICAgIGNvbnRyb2xHcm91cC5yZW1vdmVDbGFzcyhcImVycm9yXCIpO1xuICAgICAgcmV0dXJuICQoXCIuaGVscC1pbmxpbmVcIiwgY29udHJvbEdyb3VwKS5odG1sKFwiXCIpO1xuICAgIH0sXG4gICAgc2hvd0FsZXJ0OiBmdW5jdGlvbih0aXRsZSwgdGV4dCwga2xhc3MpIHtcbiAgICAgICQoXCIuYWxlcnRcIikucmVtb3ZlQ2xhc3MoXCJhbGVydC1lcnJvciBhbGVydC13YXJuaW5nIGFsZXJ0LXN1Y2Nlc3MgYWxlcnQtaW5mb1wiKTtcbiAgICAgICQoXCIuYWxlcnRcIikuYWRkQ2xhc3Moa2xhc3MpO1xuICAgICAgJChcIi5hbGVydFwiKS5odG1sKFwiPHN0cm9uZz5cIiArIHRpdGxlICsgXCI8L3N0cm9uZz4gXCIgKyB0ZXh0KTtcbiAgICAgIHJldHVybiAkKFwiLmFsZXJ0XCIpLnNob3coKTtcbiAgICB9LFxuICAgIGhpZGVBbGVydDogZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gJChcIi5hbGVydFwiKS5oaWRlKCk7XG4gICAgfVxuICB9O1xuXG59KS5jYWxsKHRoaXMpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgdmlld3MsXG4gICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbiAgdmlld3MgPSByZXF1aXJlKCcuLi92aWV3cycpO1xuXG4gIHZpZXdzLkFib3V0VmlldyA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgICBfX2V4dGVuZHMoQWJvdXRWaWV3LCBfc3VwZXIpO1xuXG4gICAgZnVuY3Rpb24gQWJvdXRWaWV3KG9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICBBYm91dFZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICB0aGlzLnJlbmRlcigpO1xuICAgIH1cblxuICAgIEFib3V0Vmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIoKSk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgcmV0dXJuIEFib3V0VmlldztcblxuICB9KShCYWNrYm9uZS5WaWV3KTtcblxufSkuY2FsbCh0aGlzKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIHZpZXdzLFxuICAgIF9faGFzUHJvcCA9IHt9Lmhhc093blByb3BlcnR5LFxuICAgIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG4gIHZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxuICB2aWV3cy5IZWFkZXJWaWV3ID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICAgIF9fZXh0ZW5kcyhIZWFkZXJWaWV3LCBfc3VwZXIpO1xuXG4gICAgZnVuY3Rpb24gSGVhZGVyVmlldyhvcHRpb25zKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgSGVhZGVyVmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgfVxuXG4gICAgSGVhZGVyVmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIoKSk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgSGVhZGVyVmlldy5wcm90b3R5cGUuc2VsZWN0TWVudUl0ZW0gPSBmdW5jdGlvbihtZW51SXRlbSkge1xuICAgICAgJChcIi5uYXYgbGlcIikucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XG4gICAgICBpZiAobWVudUl0ZW0pIHtcbiAgICAgICAgcmV0dXJuICQoXCIuXCIgKyBtZW51SXRlbSkuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHJldHVybiBIZWFkZXJWaWV3O1xuXG4gIH0pKEJhY2tib25lLlZpZXcpO1xuXG59KS5jYWxsKHRoaXMpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgdmlld3MsXG4gICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbiAgdmlld3MgPSByZXF1aXJlKCcuLi92aWV3cycpO1xuXG4gIHZpZXdzLkhvbWVWaWV3ID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICAgIF9fZXh0ZW5kcyhIb21lVmlldywgX3N1cGVyKTtcblxuICAgIGZ1bmN0aW9uIEhvbWVWaWV3KG9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICBIb21lVmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgfVxuXG4gICAgSG9tZVZpZXcucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHNyYywgdGVtcGxhdGU7XG4gICAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIoKSk7XG4gICAgICBzcmMgPSBcInslIGluY2x1ZGUgJ2hlbGxvLXRwbCcgd2l0aCBjdXJyZW50X3VzZXI6J0ZyZWQnICV9XCI7XG4gICAgICB0ZW1wbGF0ZSA9IExpcXVpZC5UZW1wbGF0ZS5wYXJzZShzcmMpO1xuICAgICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tLS0tLScpO1xuICAgICAgY29uc29sZS5sb2codGVtcGxhdGUucmVuZGVyKCkpO1xuICAgICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0tLS0tLS0tLScpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgIHJldHVybiBIb21lVmlldztcblxuICB9KShCYWNrYm9uZS5WaWV3KTtcblxufSkuY2FsbCh0aGlzKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIHZpZXdzLFxuICAgIF9faGFzUHJvcCA9IHt9Lmhhc093blByb3BlcnR5LFxuICAgIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG4gIHZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxuICB2aWV3cy5QYWdpbmF0b3IgPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gICAgX19leHRlbmRzKFBhZ2luYXRvciwgX3N1cGVyKTtcblxuICAgIFBhZ2luYXRvci5wcm90b3R5cGUuY2xhc3NOYW1lID0gXCJwYWdpbmF0aW9uIHBhZ2luYXRpb24tY2VudGVyZWRcIjtcblxuICAgIGZ1bmN0aW9uIFBhZ2luYXRvcihvcHRpb25zKSB7XG4gICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgUGFnaW5hdG9yLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgdGhpcy5tb2RlbC5iaW5kKFwicmVzZXRcIiwgdGhpcy5yZW5kZXIsIHRoaXMpO1xuICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICB9XG5cbiAgICBQYWdpbmF0b3IucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGksIGl0ZW1zLCBsZW4sIHBhZ2VDb3VudDtcbiAgICAgIGl0ZW1zID0gdGhpcy5tb2RlbC5tb2RlbHM7XG4gICAgICBsZW4gPSBpdGVtcy5sZW5ndGg7XG4gICAgICBwYWdlQ291bnQgPSBNYXRoLmNlaWwobGVuIC8gOCk7XG4gICAgICAkKHRoaXMuZWwpLmh0bWwoXCI8dWwgLz5cIik7XG4gICAgICBpID0gMDtcbiAgICAgIHdoaWxlIChpIDwgcGFnZUNvdW50KSB7XG4gICAgICAgICQoXCJ1bFwiLCB0aGlzLmVsKS5hcHBlbmQoXCI8bGlcIiArICgoaSArIDEpID09PSB0aGlzLm9wdGlvbnMucGFnZSA/IFwiIGNsYXNzPSdhY3RpdmUnXCIgOiBcIlwiKSArIFwiPjxhIGhyZWY9JyN3aW5lcy9wYWdlL1wiICsgKGkgKyAxKSArIFwiJz5cIiArIChpICsgMSkgKyBcIjwvYT48L2xpPlwiKTtcbiAgICAgICAgaSsrO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgIHJldHVybiBQYWdpbmF0b3I7XG5cbiAgfSkoQmFja2JvbmUuVmlldyk7XG5cbn0pLmNhbGwodGhpcyk7XG4iLCIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNi4zXG4oZnVuY3Rpb24oKSB7XG4gIHZhciB2aWV3cyxcbiAgICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcblxuICB2aWV3cyA9IHJlcXVpcmUoJy4uL3ZpZXdzJyk7XG5cbiAgdmlld3MuV2luZUxpc3RJdGVtVmlldyA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgICBfX2V4dGVuZHMoV2luZUxpc3RJdGVtVmlldywgX3N1cGVyKTtcblxuICAgIFdpbmVMaXN0SXRlbVZpZXcucHJvdG90eXBlLnRhZ05hbWUgPSBcImxpXCI7XG5cbiAgICBmdW5jdGlvbiBXaW5lTGlzdEl0ZW1WaWV3KG9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICBXaW5lTGlzdEl0ZW1WaWV3Ll9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgdGhpcy5tb2RlbC5iaW5kKFwiY2hhbmdlXCIsIHRoaXMucmVuZGVyLCB0aGlzKTtcbiAgICAgIHRoaXMubW9kZWwuYmluZChcImRlc3Ryb3lcIiwgdGhpcy5jbG9zZSwgdGhpcyk7XG4gICAgfVxuXG4gICAgV2luZUxpc3RJdGVtVmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIodGhpcy5tb2RlbC50b0pTT04oKSkpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfTtcblxuICAgIHJldHVybiBXaW5lTGlzdEl0ZW1WaWV3O1xuXG4gIH0pKEJhY2tib25lLlZpZXcpO1xuXG59KS5jYWxsKHRoaXMpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjYuM1xuKGZ1bmN0aW9uKCkge1xuICB2YXIgdmlld3MsXG4gICAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gICAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbiAgdmlld3MgPSByZXF1aXJlKCcuLi92aWV3cycpO1xuXG4gIHZpZXdzLldpbmVMaXN0VmlldyA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgICBfX2V4dGVuZHMoV2luZUxpc3RWaWV3LCBfc3VwZXIpO1xuXG4gICAgZnVuY3Rpb24gV2luZUxpc3RWaWV3KG9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICBXaW5lTGlzdFZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICB0aGlzLnJlbmRlcigpO1xuICAgIH1cblxuICAgIFdpbmVMaXN0Vmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgZW5kUG9zLCBpLCBsZW4sIHN0YXJ0UG9zLCB3aW5lcztcbiAgICAgIHdpbmVzID0gdGhpcy5tb2RlbC5tb2RlbHM7XG4gICAgICBsZW4gPSB3aW5lcy5sZW5ndGg7XG4gICAgICBzdGFydFBvcyA9ICh0aGlzLm9wdGlvbnMucGFnZSAtIDEpICogODtcbiAgICAgIGVuZFBvcyA9IE1hdGgubWluKHN0YXJ0UG9zICsgOCwgbGVuKTtcbiAgICAgICQodGhpcy5lbCkuaHRtbChcIjx1bCBjbGFzcz1cXFwidGh1bWJuYWlsc1xcXCI+PC91bD5cIik7XG4gICAgICBpID0gc3RhcnRQb3M7XG4gICAgICB3aGlsZSAoaSA8IGVuZFBvcykge1xuICAgICAgICAkKFwiLnRodW1ibmFpbHNcIiwgdGhpcy5lbCkuYXBwZW5kKG5ldyB2aWV3cy5XaW5lTGlzdEl0ZW1WaWV3KHtcbiAgICAgICAgICBtb2RlbDogd2luZXNbaV1cbiAgICAgICAgfSkucmVuZGVyKCkuZWwpO1xuICAgICAgICBpKys7XG4gICAgICB9XG4gICAgICAkKHRoaXMuZWwpLmFwcGVuZChuZXcgdmlld3MuUGFnaW5hdG9yKHtcbiAgICAgICAgbW9kZWw6IHRoaXMubW9kZWwsXG4gICAgICAgIHBhZ2U6IHRoaXMub3B0aW9ucy5wYWdlXG4gICAgICB9KS5yZW5kZXIoKS5lbCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9O1xuXG4gICAgcmV0dXJuIFdpbmVMaXN0VmlldztcblxuICB9KShCYWNrYm9uZS5WaWV3KTtcblxufSkuY2FsbCh0aGlzKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS42LjNcbihmdW5jdGlvbigpIHtcbiAgdmFyIHV0aWxzLCB2aWV3cyxcbiAgICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcblxuICB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzJyk7XG5cbiAgdmlld3MgPSByZXF1aXJlKCcuLi92aWV3cycpO1xuXG4gIHZpZXdzLldpbmVWaWV3ID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICAgIF9fZXh0ZW5kcyhXaW5lVmlldywgX3N1cGVyKTtcblxuICAgIGZ1bmN0aW9uIFdpbmVWaWV3KG9wdGlvbnMpIHtcbiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgICBXaW5lVmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICAgIHRoaXMucmVuZGVyKCk7XG4gICAgfVxuXG4gICAgV2luZVZpZXcucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgJCh0aGlzLmVsKS5odG1sKHRoaXMudGVtcGxhdGUucmVuZGVyKHRoaXMubW9kZWwudG9KU09OKCkpKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH07XG5cbiAgICBXaW5lVmlldy5wcm90b3R5cGUuZXZlbnRzID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBcImNoYW5nZVwiOiBcImNoYW5nZVwiLFxuICAgICAgICBcImNsaWNrIC5zYXZlXCI6IFwiYmVmb3JlU2F2ZVwiLFxuICAgICAgICBcImNsaWNrIC5kZWxldGVcIjogXCJkZWxldGVXaW5lXCIsXG4gICAgICAgIFwiZHJvcCAjcGljdHVyZVwiOiBcImRyb3BIYW5kbGVyXCJcbiAgICAgIH07XG4gICAgfTtcblxuICAgIFdpbmVWaWV3LnByb3RvdHlwZS5jaGFuZ2UgPSBmdW5jdGlvbihldmVudCkge1xuICAgICAgdmFyIGNoYW5nZSwgY2hlY2ssIHRhcmdldDtcbiAgICAgIHV0aWxzLmhpZGVBbGVydCgpO1xuICAgICAgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgICAgY2hhbmdlID0ge307XG4gICAgICBjaGFuZ2VbdGFyZ2V0Lm5hbWVdID0gdGFyZ2V0LnZhbHVlO1xuICAgICAgdGhpcy5tb2RlbC5zZXQoY2hhbmdlKTtcbiAgICAgIGNoZWNrID0gdGhpcy5tb2RlbC52YWxpZGF0ZUl0ZW0odGFyZ2V0LmlkKTtcbiAgICAgIGlmIChjaGVjay5pc1ZhbGlkID09PSBmYWxzZSkge1xuICAgICAgICByZXR1cm4gdXRpbHMuYWRkVmFsaWRhdGlvbkVycm9yKHRhcmdldC5pZCwgY2hlY2subWVzc2FnZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdXRpbHMucmVtb3ZlVmFsaWRhdGlvbkVycm9yKHRhcmdldC5pZCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIFdpbmVWaWV3LnByb3RvdHlwZS5iZWZvcmVTYXZlID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgY2hlY2s7XG4gICAgICBjaGVjayA9IHRoaXMubW9kZWwudmFsaWRhdGVBbGwoKTtcbiAgICAgIGlmIChjaGVjay5pc1ZhbGlkID09PSBmYWxzZSkge1xuICAgICAgICB1dGlscy5kaXNwbGF5VmFsaWRhdGlvbkVycm9ycyhjaGVjay5tZXNzYWdlcyk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuc2F2ZVdpbmUoKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuXG4gICAgV2luZVZpZXcucHJvdG90eXBlLnNhdmVXaW5lID0gZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgY29uc29sZS5sb2coXCJiZWZvcmUgc2F2ZVwiKTtcbiAgICAgIHJldHVybiB0aGlzLm1vZGVsLnNhdmUobnVsbCwge1xuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihtb2RlbCkge1xuICAgICAgICAgIF90aGlzLnJlbmRlcigpO1xuICAgICAgICAgIGFwcC5uYXZpZ2F0ZShcIndpbmVzL1wiICsgbW9kZWwuaWQsIGZhbHNlKTtcbiAgICAgICAgICByZXR1cm4gdXRpbHMuc2hvd0FsZXJ0KFwiU3VjY2VzcyFcIiwgXCJXaW5lIHNhdmVkIHN1Y2Nlc3NmdWxseVwiLCBcImFsZXJ0LXN1Y2Nlc3NcIik7XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICByZXR1cm4gdXRpbHMuc2hvd0FsZXJ0KFwiRXJyb3JcIiwgXCJBbiBlcnJvciBvY2N1cnJlZCB3aGlsZSB0cnlpbmcgdG8gZGVsZXRlIHRoaXMgaXRlbVwiLCBcImFsZXJ0LWVycm9yXCIpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9O1xuXG4gICAgV2luZVZpZXcucHJvdG90eXBlLmRlbGV0ZVdpbmUgPSBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMubW9kZWwuZGVzdHJveSh7XG4gICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGFsZXJ0KFwiV2luZSBkZWxldGVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgICByZXR1cm4gd2luZG93Lmhpc3RvcnkuYmFjaygpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9O1xuXG4gICAgV2luZVZpZXcucHJvdG90eXBlLmRyb3BIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgIHZhciBlLCByZWFkZXI7XG4gICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBlID0gZXZlbnQub3JpZ2luYWxFdmVudDtcbiAgICAgIGUuZGF0YVRyYW5zZmVyLmRyb3BFZmZlY3QgPSBcImNvcHlcIjtcbiAgICAgIHRoaXMucGljdHVyZUZpbGUgPSBlLmRhdGFUcmFuc2Zlci5maWxlc1swXTtcbiAgICAgIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiAkKFwiI3BpY3R1cmVcIikuYXR0cihcInNyY1wiLCByZWFkZXIucmVzdWx0KTtcbiAgICAgIH07XG4gICAgICByZXR1cm4gcmVhZGVyLnJlYWRBc0RhdGFVUkwodGhpcy5waWN0dXJlRmlsZSk7XG4gICAgfTtcblxuICAgIHJldHVybiBXaW5lVmlldztcblxuICB9KShCYWNrYm9uZS5WaWV3KTtcblxufSkuY2FsbCh0aGlzKTtcbiJdfQ==
