#+--------------------------------------------------------------------+
#| Controller.coffee
#+--------------------------------------------------------------------+
#| Copyright DarkOverlordOfData (c) 2012 - 2013
#+--------------------------------------------------------------------+
#|
#| This file is a part of Exspresso
#|
#| Exspresso is free software; you can copy, modify, and distribute
#| it under the terms of the MIT License
#|
#+--------------------------------------------------------------------+

#
# Exspresso Application Controller Class
#
# This class object is the super class for all controllers
#
#
muninn  = require('../muninn')

class muninn.core.Controller

  @suffix = 'Action'
  #
  # @property [String] module name
  #
  module: ''

  constructor: (@req, @res, @next) ->
    muninn.logMessage 'debug', "Controller Class Initialized"
    @load = new muninn.core.Loader(@)
    @load.initialize()  # do the autoloads

  #
  # Render a view
  #
  #
  # Use magic to make the controller context the
  # superclass of the data hash, allowing loaded
  # libraries to be referenced in a view:
  #
  # @example
  #
  #   <%- @pagination.createLinks() %>
  #
  #
  # @param  [String]  view path to the view template
  # @param  [Object]  data hash of data to render with template
  # @param  [Function]  next  callback
  # @return [Void]
  #
  render: ($res, $view, $data = {}, $next) ->

    $res.render $view, muninn.magic(@, $data), ($err, $html) =>

      return $next($err, $html) if $next?
      return muninn.showError($err) if $err?
      try
        $res.writeHead 200,
          'Content-Length'  : $html.length
          'Content-Type'    : 'text/html; charset=utf-8'
        $res.end $html
      catch $e
        console.log '==============================='
        console.log $e
        console.log '==============================='

  #
  # Redirect to another url
  #
  # @param  [String]  url the url to redirect to
  # @return [Void]
  #
  redirect: ($res, $url) ->

    $res.writeHead 302,
      'Location': $url
    $res.end null



module.exports = muninn.core.Controller

